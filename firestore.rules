rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read/write their own profile
    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;

      // User progress subcollection
      match /progress/{eraId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      // User achievements subcollection
      match /achievements/{achievementId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if request.auth != null && request.auth.uid == uid;
      }

      // Daily challenge completions subcollection
      match /dailyChallengeCompletions/{date} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // Eras are readable by any authenticated user
    match /eras/{eraId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions write eras

      // Lessons within an era
      match /lessons/{lessonId} {
        allow read: if request.auth != null;
        allow write: if false; // Only Cloud Functions write lessons
      }
    }

    // Leaderboard is readable by any authenticated user
    match /leaderboard/{period} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions update leaderboard
    }

    // Battles: players can read, Cloud Functions manage state
    match /battles/{battleId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions manage battles
    }

    // Daily challenges: readable by authenticated users, written by Cloud Functions
    match /dailyChallenges/{date} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions write daily challenges
    }
  }
}
